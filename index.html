<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Platformer with Invulnerability</title>
  <style>
    body { margin:0; background:#111; }
    canvas { display:block; }
    .hud { position:fixed; inset:0; pointer-events:none; }
    .stick-area, .btn { pointer-events:auto; touch-action:none; }
    .stick-area {
      position:fixed; bottom:16px; left:16px; width:120px; height:120px;
      border-radius:50%; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
    }
    .stick-knob {
      position:absolute; left:50%; top:50%; width:40px; height:40px;
      border-radius:50%; background:#0af; transform:translate(-50%,-50%);
    }
    .btn {
      position:fixed; right:16px; bottom:16px; width:80px; height:80px;
      border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center;
      font-weight:bold; user-select:none;
    }
    .label {
      position:fixed; top:8px; left:50%; transform:translateX(-50%);
      color:#fff; font-family:sans-serif; font-size:18px; background:rgba(0,0,0,0.4);
      padding:6px 10px; border-radius:8px;
    }
    #skipBtn {
      position:fixed; top:60px; right:20px;
      background:#fff; border:none; padding:8px 12px; border-radius:6px; font-weight:bold; display:none; cursor:pointer;
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hud">
  <div class="label" id="levelLabel">Level 1 | Coins: 0</div>
  <div id="moveStick" class="stick-area"><div id="moveKnob" class="stick-knob"></div></div>
  <div id="jumpBtn" class="btn">Jump</div>
</div>
<button id="skipBtn">Skip Boss</button>

<script>
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
resize(); window.addEventListener('resize',resize);

const TILE=32,GROUND_Y=15*TILE;
let coinTotal=0;
const player={x:64,y:GROUND_Y-28,w:24,h:28,vx:0,vy:0,onGround:false,jumps:0,face:1,color:"#ffd166"};

const keys={}; window.addEventListener("keydown",e=>keys[e.code]=true); window.addEventListener("keyup",e=>keys[e.code]=false);
let moveVec={x:0};
(function setupStick(){const area=document.getElementById('moveStick'),knob=document.getElementById('moveKnob');let active=false,startX=0;
area.addEventListener('touchstart',e=>{active=true;startX=e.touches[0].clientX;});
area.addEventListener('touchmove',e=>{if(!active)return;const dx=e.touches[0].clientX-startX;const radius=area.clientWidth/2-20;
const nx=Math.max(-radius,Math.min(radius,dx));knob.style.left=`calc(50% + ${nx}px)`;moveVec.x=nx/radius;});
area.addEventListener('touchend',()=>{active=false;moveVec.x=0;knob.style.left='50%';});})();
function tryJump(){if(player.jumps<2){player.vy=-520;player.onGround=false;player.jumps++;}}
document.getElementById('jumpBtn').addEventListener('touchstart',tryJump);

function aabb(ax,ay,aw,ah,bx,by,bw,bh){return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;}
function onTopOf(ax,ay,aw,ah,bx,by,bw,bh){return aabb(ax,ay,aw,ah,bx,by,bw,bh)&&(ay+ah)<=(by+10)&&player.vy>=0;}

// --- Invulnerability variables ---
let invulnerable=false;
let invulnTimer=0;

// Kill player wrapper
function killPlayer(){
  loadLevel(levelIndex);       // reset level
  invulnerable=true;           // turn on invulnerability
  invulnTimer=1.0;             // 1 second
}

let levelIndex=1,level=null;const bullets=[];
function setHUD(name){document.getElementById("levelLabel").textContent=`${name} | Coins: ${coinTotal}`;}
function makeLevelBase(name){return{name,bg:"#222",platforms:[],hazards:[],coins:[],enemies:[],boss:false,goal:{x:canvas.width-140,y:GROUND_Y-32,w:90,h:32}};}

function genTutorial(){const L=makeLevelBase("Level 1 - Tutorial");L.bg="#254027";
L.platforms.push({x:200,y:GROUND_Y-80,w:100,h:12});L.coins.push({x:220,y:GROUND_Y-100,r:10,collected:false});
return L;}

function genGrasslands(i){const L=makeLevelBase(`Level ${i} - Grasslands`);L.bg="#254027";
L.platforms.push({x:260,y:GROUND_Y-100,w:110,h:12});L.coins.push({x:280,y:GROUND_Y-120,r:10,collected:false});
L.enemies.push({type:"patrol",x:320,y:GROUND_Y-28,w:24,h:28,dir:1,minX:300,maxX:520,speed:60});
return L;}

function genBoss(i){const L=makeLevelBase(`Level ${i} - Boss`);L.bg="#2a1f1f";L.boss=true;L.goal=null;
L.enemies.push({type:"boss",x:520,y:GROUND_Y-80,w:100,h:100,hp:6,fire:0,rate:0.9});return L;}

function generateLevel(i){if(i===1)return genTutorial();if(i%10===0)return genBoss(i);return genGrasslands(i);}
function loadLevel(idx){levelIndex=((idx-1)%100)+1;level=generateLevel(levelIndex);
player.x=64;player.y=GROUND_Y-28;player.vx=0;player.vy=0;player.jumps=0;player.onGround=false;player.face=1;
bullets.length=0;setHUD(level.name);document.getElementById("skipBtn").style.display=level.boss?"block":"none";}
loadLevel(1);document.getElementById("skipBtn").onclick=()=>loadLevel(levelIndex+1);

function update(dt){
  const L=level;const gravity=1000;const baseSpeed=240;
  const left=keys["ArrowLeft"]||keys["KeyA"]||moveVec.x<-0.2;const right=keys["ArrowRight"]||keys["KeyD"]||moveVec.x>0.2;
  if(left&&!right){player.vx=-baseSpeed;player.face=-1;}else if(right&&!left){player.vx=baseSpeed;player.face=1;}else player.vx*=0.85;
  if(keys["Space"]||keys["ArrowUp"]||keys["KeyW"])tryJump();
  player.vy+=gravity*dt;player.x+=player.vx*dt;player.y+=player.vy*dt;
  if(player.y+player.h>GROUND_Y){player.y=GROUND_Y-player.h;player.vy=0;player.onGround=true;player.jumps=0;}else player.onGround=false;

  // --- Invulnerability timer update ---
  if(invulnerable){invulnTimer-=dt;if(invulnTimer<=0)invulnerable=false;}

  // Hazards (only if not invulnerable)
  if(!invulnerable){
    for(const h of L.hazards){if(aabb(player.x,player.y,player.w,player.h,h.x,h.y,h.w,h.h)){killPlayer();return;}}
    for(const e of L.enemies){if(aabb(player.x,player.y,player.w,player.h,e.x,e.y,e.w,e.h)){killPlayer();return;}}
  }

  // Goal
  if(!L.boss&&L.goal&&aabb(player.x,player.y,player.w,player.h,L.goal.x,L.goal.y,L.goal.w,L.goal.h)){loadLevel(levelIndex+1);return;}
}

function draw(){
  const L=level;ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle=L.bg;ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#555";ctx.fillRect(0,
