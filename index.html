<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>100-Level Diverse Platformer</title>
  <style>
    body { margin:0; background:#111; }
    canvas { display:block; }
    .hud { position:fixed; inset:0; pointer-events:none; }
    .stick-area, .btn { pointer-events:auto; touch-action:none; }
    .stick-area {
      position:fixed; bottom:16px; left:16px; width:120px; height:120px;
      border-radius:50%; background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
    }
    .stick-knob {
      position:absolute; left:50%; top:50%; width:40px; height:40px;
      border-radius:50%; background:#0af; transform:translate(-50%,-50%);
    }
    .btn {
      position:fixed; right:16px; bottom:16px; width:80px; height:80px;
      border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center;
      font-weight:bold; user-select:none;
    }
    .label {
      position:fixed; top:8px; left:50%; transform:translateX(-50%);
      color:#fff; font-family:sans-serif; font-size:18px; background:rgba(0,0,0,0.4);
      padding:6px 10px; border-radius:8px;
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hud">
  <div class="label" id="levelLabel">Level 1 | Coins: 0</div>
  <div id="moveStick" class="stick-area"><div id="moveKnob" class="stick-knob"></div></div>
  <div id="jumpBtn" class="btn">Jump</div>
</div>

<script>
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;canvas.height=window.innerHeight;

const TILE=32,W=32,H=16;
let coinTotal=0,playerColor="#ffd166",hasKey=false;

// Player with double jump
const player={x:0,y:0,w:24,h:28,vx:0,vy:0,onGround:false,jumps:0};

// Helpers
const makeRow=(f=0)=>Array(W).fill(f);
function place(tiles,y,x1,x2,type){for(let x=x1;x<=x2;x++)tiles[y][x]=type;}
function baseLevel(goalX){const t=Array.from({length:H},()=>makeRow(0));place(t,15,0,31,1);t[15][goalX]=4;return t;}

// Level list
const levels=[];

// Seed a few handcrafted levels
levels.push({name:"Level 1 - Intro",tiles:baseLevel(30),start:{x:TILE*2,y:(15*TILE)-28},coins:[{x:220,y:440,collected:false}],items:[],platforms:[],enemies:[],dark:false});
levels.push({name:"Level 2 - Platforms",tiles:(()=>{const t=baseLevel(28);place(t,13,10,10,1);place(t,13,14,14,1);place(t,13,18,18,1);return t;})(),start:{x:TILE*2,y:(15*TILE)-28},coins:[{x:320,y:360,collected:false},{x:520,y:360,collected:false}],items:[],platforms:[],enemies:[{type:"patrol",x:360,y:450,w:24,h:28,dir:1,minX:320,maxX:560,speed:60}],dark:false});

// Procedural generation for levels 3..100
for(let i=3;i<=100;i++){
  const name="Level "+i;
  const tiles=baseLevel((i%2===0)?26:29);
  if(i%3===0)place(tiles,14,6,10,2); // hazards
  if(i%5===0)tiles[14][20]=5;        // bounce pad
  if(i%4===0){for(let x=22;x<=25;x++)tiles[13][x]=6;} // breakables
  if(i%7===0){tiles[15][29]=1;tiles[6][28]=4;place(tiles,8,20,21,1);} // vertical goal
  const coins=[{x:(8+(i%20))*TILE,y:360,collected:false},{x:(14+(i%12))*TILE,y:320,collected:false}];
  const items=(i%6===0)?[{type:"key",x:(12+(i%8))*TILE,y:12*TILE,collected:false}]:[];
  const platforms=(i%2===1)?[{x:16*TILE,y:11*TILE,w:TILE,h:TILE,vx:0,vy:-40,minY:9*TILE,maxY:12*TILE}]:[];
  const enemies=[{type:"patrol",x:320,y:450,w:24,h:28,dir:1,minX:280,maxX:620,speed:60+2*i}];
  if(i%3===1)enemies.push({type:"fly",x:480,y:360,w:22,h:22,t:0,ampX:40,ampY:25,baseX:480,baseY:360,speed:2});
  if(i%5===2)enemies.push({type:"chase",x:520,y:450,w:24,h:28,speed:85,range:240});
  levels.push({name,tiles,start:{x:TILE*2,y:(15*TILE)-28},coins,items,platforms,enemies,dark:(i%8===0)});
}

let levelIndex=0;
function loadLevel(i){
  levelIndex=i%levels.length;hasKey=false;
  document.getElementById("levelLabel").textContent=levels[levelIndex].name+" | Coins: "+coinTotal;
  player.x=levels[levelIndex].start.x;player.y=levels[levelIndex].start.y;
  player.vx=player.vy=0;player.jumps=0;
}
loadLevel(0);

// Input
const keys={};
window.addEventListener("keydown",e=>keys[e.code]=true);
window.addEventListener("keyup",e=>keys[e.code]=false);

// Touch joystick
let moveVec={x:0};
(function setupStick(){
  const area=document.getElementById('moveStick'),knob=document.getElementById('moveKnob');
  let active=false,startX=0;
  area.addEventListener('touchstart',e=>{active=true;startX=e.touches[0].clientX;});
  area.addEventListener('touchmove',e=>{
    if(!active)return;
    const dx=e.touches[0].clientX-startX;
    const radius=area.clientWidth/2-20;
    const nx=Math.max(-radius,Math.min(radius,dx));
    knob.style.left=`calc(50% + ${nx}px)`;moveVec.x=nx/radius;
  });
  area.addEventListener('touchend',()=>{active=false;moveVec.x=0;knob.style.left='50%';});
})();

// Double jump
function tryJump(){if(player.jumps<2){player.vy=-500;player.onGround=false;player.jumps++;}}
document.getElementById('jumpBtn').addEventListener('touchstart',tryJump);

// Tile sampling
function tileAt(px,py){const L=levels[levelIndex];const tx=Math.floor(px/TILE),ty=Math.floor(py/TILE);if(tx<0||ty<0||tx>=W||ty>=H)return 0;return L.tiles[ty][tx];}
function solidTile(t){return t===1||t===4||t===6||t===8||t===5;}

function update(dt){
  const L=levels[levelIndex];
  const left=keys["ArrowLeft"]||moveVec.x<-0.2;
  const right=keys["ArrowRight"]||moveVec.x>0.2;
  if(left&&!right)player.vx=-200;else if(right&&!left)player.vx=200;else player.vx=0;
  if(keys["Space"])tryJump();

  player.vy+=1000*dt;player.x+=player.vx*dt;player.y+=player.vy*dt;

  // Platforms
  for(const p of L.platforms){
    if(p.vx){p.x+=p.vx*dt;if(p.x<p.minX||p.x>p.maxX)p.vx*=-1;}
    if(p.vy){p.y+=p.vy*dt;if(p.y<p.minY||p.y>p.maxY)p.vy*=-1;}
  }

  const footX=
